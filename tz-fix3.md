## Техническое задание: интеграция admin-panel, sro-backend, sro-frontend и Postman. Полный план и чек-листы

Ниже — полный план доведения системы до идеальной согласованной работы. Все задачи оформлены чекбоксами для поэтапной приемки. Перед каждым пунктом крупными буквами указан контур внесения изменений: БД, БЕКЕНД, АДМИН ПАНЕЛЬ, ФРОНТ, POSTMAN.

### Общая архитектура и принципы
- [x] БЕКЕНД — Установить единый префикс API `/api` (уже задан через `app.setGlobalPrefix`).
- [ ] ФРОНТ — Везде использовать `NEXT_PUBLIC_API_URL=http://localhost:3001/api` (admin-panel и sro-frontend).
- [x] БЕКЕНД — Возвращать ответы в унифицированном формате `ResponseUtil` (`{ success, data, message, pagination? }`).
- [x] БЕКЕНД — Отдавать статику из `uploads/` с префиксом `/uploads/` (настроено в `main.ts`).
- [x] БД — Проверить индексы на коллекциях с частыми фильтрами (documents: `category`, `isPublic`, `tags`, `uploadedAt`; login-attempts: `createdAt`, `ipAddress`).

### Хранение файлов (единые правила)
- [x] БЕКЕНД — Базовая директория: `uploads/`.
- [x] БЕКЕНД — Документы: `uploads/documents` (загрузка через `/documents/upload`).
- [x] БЕКЕНД — Общие файлы/изображения: `uploads/files` (+ миниатюры `uploads/files/thumbnails`).
- [x] БЕКЕНД — Временные файлы: `uploads/temp`.
- [x] АДМИН ПАНЕЛЬ — Все ссылки на файлы формировать как абсолютные: `<BE>/uploads/...`.
- [x] АДМИН ПАНЕЛЬ — Для логотипа/фавиконки выполнять upload в `/files/upload` и сохранять в настройках URL (`themeSettings.logoUrl`/`faviconUrl`).

---

### Настройки сайта: /settings (админ-панель: http://localhost:3002/settings)

Текущее состояние (бекенд): есть `SettingsModule`, контроллер и сервис. Эндпоинты: GET `/settings`, PUT `/settings`, GET `/settings/theme`, PUT `/settings/theme`, GET `/settings/seo`, GET `/settings/contact`, PUT `/settings/reset`, GET `/settings/history`.

- [x] БЕКЕНД — В PUT `/settings` убедиться, что сохраняются все поля из DTO (`UpdateSiteSettingsDto`), включая `seoSettings`, `themeSettings`, `socialLinks`, контакты/адрес/график.
- [x] АДМИН ПАНЕЛЬ — Привести `/settings` к единому экрану. Сейчас есть дубли (`src/app/settings/page.tsx` и `src/app/settings/site/page.tsx`). 
  - [x] АДМИН ПАНЕЛЬ — Либо удалить/переадресовать старую страницу на `/settings/site`, либо оставить один вариант, использующий `useSiteSettings` с zod-валидацией.
- [x] АДМИН ПАНЕЛЬ — Добавить реальную загрузку логотипа/иконки через `/files/upload` вместо хранения base64; после ответа подставлять URL в `themeSettings` и выполнять PUT `/settings`.
- [x] POSTMAN — Проверить/добавить коллекции для: GET/PUT `/api/settings`, GET `/api/settings/theme|seo|contact`, PUT `/api/settings/reset`, GET `/api/settings/history`.

Проверки после этапа
- [x] БЕКЕНД — Через Postman: GET/PUT `/api/settings` (изменить значение и убедиться, что читается корректно).
- [x] АДМИН ПАНЕЛЬ — На `http://localhost:3002/settings`/`/settings/site` изменить все разделы, сохранить, обновить страницу — изменения остаются.
- [x] АДМИН ПАНЕЛЬ — Загрузить логотип/фавиконку, проверить, что файл появился в `uploads/files` и URL работает.

---

### Документы: /documents (админ-панель: http://localhost:3002/documents, публичный сайт — раздел Документы)

Текущее состояние (бекенд): есть `DocumentsModule` со следующими маршрутами (создание, загрузка, поиск, публичные, категории, версии, скачивание/превью, удаление, bulk-удаление). Схема `document.schema.ts` включает категории (enum): `regulatory`, `rules`, `reports`, `compensation-fund`, `labor-activity`, `accreditation`, `other`.

- [ ] БЕКЕНД — Оставить текущие лимиты/валидации загрузок (Multer `memoryStorage`, `limits.fileSize=50MB`).
- [ ] ФРОНТ — В публичном фронте (sro-frontend) подгружать документы из Public API: `GET /documents/public?category=...` и ссылки на скачивание `/documents/:id/download`.
- [ ] ФРОНТ — Синхронизировать перечень категорий с бекенд-списком (в компонентах встречаются `founding`, `internal` — привести к бэкенд enum или настроить отображение/маппинг).
- [ ] АДМИН ПАНЕЛЬ — В `DocumentUpload` использовать `POST /documents/upload` и показывать прогресс/ошибки; после загрузки — рефреш списка.
- [ ] АДМИН ПАНЕЛЬ — Убедиться, что фильтры/пагинация соответствуют `DocumentQueryDto` (в `services/admin/documents.ts` уже подготовлены параметры).
- [ ] POSTMAN — Добавить сценарии загрузки, версионирования, скачивания/превью, публичной выборки.

Проверки после этапа
- [ ] АДМИН ПАНЕЛЬ — Загрузить документ, проверить появление файла в `uploads/documents`, открыть превью и скачать.
- [ ] ФРОНТ — Страницы документов отображают данные с API, сортировки/категории работают, ссылки на скачивание активны.

---

### Безопасность: /settings/security (админ-панель: http://localhost:3002/settings/security)

Текущее состояние: в админ-панели хук `useSecuritySettings` вызывает эндпоинты `/security/*`, но в бекенде таких маршрутов пока нет (частично есть логирование в `LoginLoggerService`). Требуется модуль безопасности.

Минимальный объём (бекенд):
- [x] БЕКЕНД — Создать `SecurityModule` с контроллером/сервисом.
- [x] БД — Добавить коллекции:
  - [x] БД — `blocked_ips` (ipAddress, reason, createdAt, createdBy, optional expiresAt).
  - [x] БД — (опционально) `user_sessions` — использованы `RefreshToken` как активные сессии.
- [x] БЕКЕНД — Реализовать маршруты:
  - [x] БЕКЕНД — `GET /security/events` — выборка событий (на базе `login-attempts`), фильтры: тип, userId, период, пагинация.
  - [x] БЕКЕНД — `GET /security/stats?period=day|week|month` — агрегаты по событиям.
  - [x] БЕКЕНД — `POST /security/block-ip`, `POST /security/unblock-ip` — управление блокировками (использовать `blocked_ips`).
  - [x] БЕКЕНД — `GET /security/blocked-ips` — список блокировок.
  - [x] БЕКЕНД — `GET /security/active-sessions` — список активных сессий.
  - [x] БЕКЕНД — `POST /security/reset-failed-attempts` — сброс счётчиков для пользователя.
  - [x] БЕКЕНД — `POST /security/terminate-sessions` — завершение сессий пользователя.
  - [x] БЕКЕНД — `POST /security/test-settings` — пробный прогон политик/ограничений.
- [x] БЕКЕНД — В `AuthController` интегрировать проверку блокировки IP и лимита попыток до выдачи JWT (использовать `LoginLoggerService.isIpBlocked`).

Админ-панель (подключение):
- [x] АДМИН ПАНЕЛЬ — Обновить `useSecuritySettings` под фактические маршруты `/api/security/*` (совместимо, используются те же пути).
- [x] АДМИН ПАНЕЛЬ — Разделить сохранение «настроек безопасности» на отдельный endpoint (`PUT /settings/security`) — добавлен контроллер.
- [x] АДМИН ПАНЕЛЬ — Таб «Логи безопасности/Мониторинг» подключить к `GET /security/events` и `GET /security/stats`.

Проверки после этапа
- [x] БЕКЕНД — Смоделировать несколько неуспешных логинов, проверить `GET /api/security/events`/`/api/security/stats`.
- [x] БЕКЕНД — Заблокировать IP и убедиться, что логин с этого IP отклоняется.
- [x] АДМИН ПАНЕЛЬ — На `http://localhost:3002/settings/security` отображаются события/статистика, работают блокировка/разблокировка IP, экспорт логов.
- [x] POSTMAN — Добавить коллекцию Security (в Admin API) со всеми маршрутами.

---

### Публичный фронт (sro-frontend)
- [ ] ФРОНТ — Проверить `API_BASE_URL` в `src/constants/index.ts` → `http://localhost:3001/api`.
- [ ] ФРОНТ — Документы получать из `/documents/public` с параметрами `category`, `search`, `page`, `limit`.
- [ ] ФРОНТ — Ссылки на скачивание вести на `/documents/:id/download`.
- [ ] ФРОНТ — Контакты/логотип/SEO подтягивать из `/api/settings` (перестать хардкодить в футере).

Проверки после этапа
- [ ] ФРОНТ — Раздел Документы отображает актуальные данные с API; быстрые ссылки ведут в нужные категории.
- [ ] ФРОНТ — Футер/контакты соответствуют данным из `/api/settings`.

---

### Postman коллекции
- [ ] POSTMAN — Унифицировать все запросы на префикс `/api` (в коллекциях местами используется и без префикса). Базовый URL `{{baseUrl}}=http://localhost:3001`.
- [ ] POSTMAN — Добавить раздел Security (Admin API): `events`, `stats`, `block-ip`, `unblock-ip`, `blocked-ips`, `active-sessions`, `reset-failed-attempts`, `terminate-sessions`, `test-settings`.
- [ ] POSTMAN — Перепроверить документы: загрузка/версии/публичная выборка/скачивание/превью.
- [ ] POSTMAN — Перепроверить настройки: полный цикл GET/PUT/RESET/HISTORY.

---

### План этапов и запуск после каждого
1) Настройки сайта (/settings)
- [ ] БЕКЕНД — Верификация DTO/эндпоинтов.
- [ ] АДМИН ПАНЕЛЬ — Единый экран настроек, upload логотипа/фавиконки через `/files/upload`.
- [ ] POSTMAN — Проверка сценариев.
- [ ] ЗАПУСК/ПРОВЕРКА — старт backend, admin-panel; тесты в Postman.

2) Документы (/documents)
- [ ] БЕКЕНД — Проверка отдачи статики и поиска/публичных маршрутов.
- [ ] АДМИН ПАНЕЛЬ — Загрузка через `/documents/upload`, фильтры/пагинация.
- [ ] ФРОНТ — Публичные страницы используют `/documents/public`.
- [ ] POSTMAN — Сценарии загрузки/версий/скачивания.
- [ ] ЗАПУСК/ПРОВЕРКА — загрузить документ, скачать, открыть превью.

3) Безопасность (/settings/security)
- [ ] БД — Коллекции `blocked_ips` (+опционально `user_sessions`).
- [ ] БЕКЕНД — `SecurityModule` и маршруты `/security/*`, интеграция проверок в логин.
- [ ] АДМИН ПАНЕЛЬ — Подключение к новым маршрутам, отдельный endpoint сохранения политик.
- [ ] POSTMAN — Набор запросов для Security.
- [ ] ЗАПУСК/ПРОВЕРКА — сгенерировать события, блокировки, выгрузку логов.

4) Публичный фронт
- [ ] ФРОНТ — Документы/настройки с API; убрать хардкод контактов/логотипа.
- [ ] ЗАПУСК/ПРОВЕРКА — ручной прогон страниц.

---

### Дополнительно: что именно «не хватает» сейчас
- [ ] БЕКЕНД — Модуля Security и маршрутов `/security/*` (требуются для страницы `/settings/security`).
- [ ] БД — Коллекции `blocked_ips` и (опционально) `user_sessions` для полной реализации требований Security.
- [ ] АДМИН ПАНЕЛЬ — Единообразного экрана настроек (есть дубли), интеграции upload логотипа/фавикона с `/files/upload`.
- [ ] ФРОНТ — Синхронизации категорий документов и вытягивания данных документов/настроек из API вместо статичных данных.
- [ ] POSTMAN — Полного раздела Security и унификации префикса `/api` во всех запросах.

# Техническое задание на исправление недочетов и подключение API к админ панели

## Общая информация
- **Проект**: Исправление недочетов в монорепозитории СРО арбитражных управляющих
- **Цель**: Устранение технических, логических и смысловых несостыковок между backend, admin-panel и frontend
- **Приоритет**: Критичные исправления → API интеграция → UI унификация

---

## I. ЗАДАЧИ ПО ИСПРАВЛЕНИЮ ВСЕХ ВЫЯВЛЕННЫХ НЕДОЧЕТОВ

### 1. КРИТИЧНЫЕ ИСПРАВЛЕНИЯ (Приоритет 1)

#### 1.1 Исправление системы аутентификации и авторизации

**Проблема**: Несоответствие форматов данных между backend и frontend

**Задачи**:
- [ ] **Backend**: В `JwtStrategy.validate` возвращать унифицированный объект `{ id: user._id.toString(), email: user.email, role: user.role, permissions: user.permissions }`
- [ ] **Backend**: Во всех контроллерах заменить `req.user.userId` → `req.user.id` (проверить файлы: `files.controller.ts`, `news.controller.ts`, `events.controller.ts`, `documents.controller.ts`, `pages.controller.ts`, `registry.controller.ts`, `inspections.controller.ts`, `disciplinary-measures.controller.ts`, `settings.controller.ts`)
- [ ] **Backend**: Привести ответы `POST /auth/login` и `POST /auth/refresh` к единому формату `{ success: true, data: { token, refreshToken, user } }`
- [ ] **Backend**: Исключить дефолтные секреты в коде; использовать только ENV переменные
- [ ] **Admin-panel**: Обновить `apiService` интерцептор для ожидания `data.token/refreshToken` вместо `access_token/refresh_token`
- [ ] **Admin-panel**: Привести `getCurrentUser` к единому формату `ApiResponse<User>` или адаптировать `AuthContext` под сырые ответы

#### 1.2 Исправление схемы пользователей

**Проблема**: Несоответствие полей между DTO и схемой MongoDB

**Задачи**:
- [ ] **Backend**: Исправить регистрацию - либо собрать `name` из `firstName/lastName/middleName`, либо расширить схему `User` на поля ФИО
- [ ] **Backend**: Убрать `role: 'USER' as any` в `AuthService.register`; использовать валидную роль из enum `UserRole`
- [ ] **Backend**: При создании пользователя автоматически проставлять `permissions` исходя из роли (из `ROLE_PERMISSIONS`)
- [ ] **Admin-panel**: Привести `UserRole` к формату бэка или ввести явный маппинг
- [ ] **Admin-panel**: Запретить строковые литералы ролей с `as UserRole`

#### 1.3 Исправление типов и дублирования

**Проблема**: Дублирование типов и несоответствие форматов

**Задачи**:
- [ ] **Admin-panel**: Удалить дубликат `ApiResponse` в `src/types/admin/index.ts`
- [ ] **Admin-panel**: Стандартизировать `Pagination` (одно имя и одна форма), обновить все сервисы
- [ ] **Admin-panel**: Унифицировать `Pagination` (`pagination` vs `meta`) во всех типах

### 2. API КОНТРАКТЫ И ЭНДПОИНТЫ (Приоритет 2)

#### 2.1 Выравнивание эндпоинтов новостей

**Проблема**: Admin-panel ожидает эндпоинты, которых нет на backend

**Задачи**:
- [ ] **Backend**: Реализовать недостающие маршруты для новостей:
  - `GET /news/public` - публичный список новостей
  - `GET /news/search?q=` - поиск по новостям
  - `GET /news/category/:category` - новости по категории
  - `PATCH /news/:id/status` - изменение статуса новости
  - `DELETE /news/bulk` - массовое удаление новостей
- [ ] **Backend**: Привести все ответы к единому формату `{ success: boolean, data?: any, pagination?: { page, limit, total, totalPages }, message?: string, error?: string }`
- [ ] **Admin-panel**: Обновить `newsService` для использования реальных эндпоинтов вместо моковых

#### 2.2 Унификация форматов ответов

**Проблема**: Неоднородные форматы ответов API

**Задачи**:
- [ ] **Backend**: Ввести единый Response Envelope по всем контроллерам
- [ ] **Backend**: Стандартизировать обработку ошибок (4xx, 5xx)
- [ ] **Backend**: Унифицировать пагинацию во всех эндпоинтах
- [ ] **Admin-panel**: Обновить все сервисы для работы с единым форматом ответов

#### 2.3 Исправление портов и URL

**Проблема**: Несоответствие портов по умолчанию

**Задачи**:
- [ ] **Backend**: Изменить порт по умолчанию с 3000 на 3001 в `app.config.ts`
- [ ] **Admin-panel**: Обновить `baseURL` по умолчанию на `http://localhost:3001/api`
- [ ] **Документация**: Обновить `.env.example` файлы с правильными портами

### 3. БЕЗОПАСНОСТЬ И НАДЕЖНОСТЬ (Приоритет 3)

#### 3.1 Усиление безопасности

**Задачи**:
- [ ] **Backend**: Вынести все JWT секреты в ENV переменные, убрать дефолты
- [ ] **Backend**: Настроить CORS по окружениям через ENV переменные
- [ ] **Backend**: Добавить rate limiting для чувствительных эндпоинтов (восстановление пароля, регистрация)
- [ ] **Backend**: Заменить `console.log` на централизованный логгер (winston)
- [ ] **Backend**: Добавить проверку файлов на вирусы (опционально)

#### 3.2 Валидация данных

**Задачи**:
- [ ] **Backend**: Валидировать даты (например, `publishedAt`) и приводить значения безопасно
- [ ] **Backend**: Централизовать валидацию типов и лимитов файлов
- [ ] **Backend**: Добавить валидацию всех входных данных через DTO

### 4. UI ЭКОСИСТЕМА (Приоритет 4)

#### 4.1 Унификация Tailwind CSS

**Проблема**: Разные версии Tailwind в admin-panel (v3) и sro-frontend (v4)

**Задачи**:
- [ ] **Admin-panel**: Перевести на Tailwind v4 (как в sro-frontend)
- [ ] **Admin-panel**: Синхронизировать дизайн-токены и утилиты с sro-frontend
- [ ] **Admin-panel**: Обновить `tailwind.config.js` до формата v4
- [ ] **Admin-panel**: Проверить совместимость всех компонентов с новой версией

#### 4.2 Синхронизация компонентных библиотек

**Задачи**:
- [ ] **Admin-panel**: Синхронизировать набор иконок с sro-frontend
- [ ] **Admin-panel**: Унифицировать цветовую схему и типографику
- [ ] **Admin-panel**: Привести компоненты к единому стилю

---

## II. ЗАДАЧИ ПО ПОДКЛЮЧЕНИЮ API К АДМИН ПАНЕЛИ

### 1. АНАЛИЗ ТЕКУЩЕГО СОСТОЯНИЯ

#### 1.1 Backend API (sro-backend)
**Статус**: ✅ Полностью реализован
- **Модули**: Auth, Users, News, Registry, Documents, Events, CompensationFund, Inspections, DisciplinaryMeasures, Pages, Settings, Files
- **API эндпоинты**: 5 уровней доступа (Public, Editor, Moderator, Admin, SuperAdmin)
- **Аутентификация**: JWT с refresh токенами, система ролей и разрешений
- **База данных**: MongoDB с полными схемами и индексами
- **Файловая система**: Загрузка, обработка изображений, безопасность

#### 1.2 Admin Panel (admin-panel)
**Статус**: ✅ Базовая структура готова, требует интеграции с API
- **Технологии**: Next.js 15, React 19, TypeScript, Tailwind CSS
- **Состояние**: Использует моковые данные с fallback на API
- **Структура**: Полная админ панель с дашбордом, управлением контентом, реестром, настройками

#### 1.3 Postman Collections
**Статус**: ✅ Полные коллекции для всех ролей
- **Коллекции**: Public API, Editor API, Moderator API, Admin API, SuperAdmin API
- **Покрытие**: Все основные эндпоинты задокументированы
- **Тестирование**: Готовы для интеграционного тестирования

### 2. ПЛАН ИНТЕГРАЦИИ API

#### 2.1 Этап 1: Базовая интеграция аутентификации

**Цель**: Настроить корректную работу аутентификации между admin-panel и backend

**Задачи**:
- [ ] **Исправить AuthContext**: Обновить `AuthContext.tsx` для работы с реальным API вместо моковых данных
- [ ] **Настроить API Service**: Обновить `api.ts` для корректной работы с backend эндпоинтами
- [ ] **Реализовать токен refresh**: Настроить автоматическое обновление токенов через интерцепторы
- [ ] **Добавить обработку ошибок**: Реализовать централизованную обработку ошибок аутентификации
- [ ] **Тестирование**: Протестировать полный цикл входа/выхода/обновления токенов

#### 2.2 Этап 2: Интеграция модуля новостей

**Цель**: Подключить управление новостями к реальному API

**Задачи**:
- [ ] **Обновить NewsService**: Адаптировать `news.ts` для работы с реальными эндпоинтами
- [ ] **Реализовать CRUD операции**: Создание, чтение, обновление, удаление новостей
- [ ] **Добавить управление категориями**: Интеграция с API категорий новостей
- [ ] **Реализовать загрузку файлов**: Интеграция с Files API для изображений
- [ ] **Добавить поиск и фильтрацию**: Использование реальных параметров API
- [ ] **Тестирование**: Протестировать все операции с новостями

#### 2.3 Этап 3: Интеграция модуля мероприятий

**Цель**: Подключить управление мероприятиями к реальному API

**Задачи**:
- [ ] **Обновить EventsService**: Адаптировать `events.ts` для работы с реальными эндпоинтами
- [ ] **Реализовать CRUD операции**: Полный цикл управления мероприятиями
- [ ] **Добавить управление типами**: Интеграция с EventType API
- [ ] **Реализовать регистрацию участников**: Использование API регистрации
- [ ] **Добавить календарный вид**: Интеграция с календарными эндпоинтами
- [ ] **Тестирование**: Протестировать все операции с мероприятиями

#### 2.4 Этап 4: Интеграция модуля документов

**Цель**: Подключить управление документами к реальному API

**Задачи**:
- [ ] **Обновить DocumentsService**: Адаптировать `documents.ts` для работы с реальными эндпоинтами
- [ ] **Реализовать загрузку файлов**: Интеграция с Files API
- [ ] **Добавить управление категориями**: Работа с категориями документов
- [ ] **Реализовать поиск и фильтрацию**: Использование реальных параметров API
- [ ] **Добавить предварительный просмотр**: Интеграция с Files API для просмотра
- [ ] **Тестирование**: Протестировать все операции с документами

#### 2.5 Этап 5: Интеграция модуля страниц

**Цель**: Подключить управление страницами к реальному API

**Задачи**:
- [ ] **Обновить PagesService**: Адаптировать `pages.ts` для работы с реальными эндпоинтами
- [ ] **Реализовать CRUD операции**: Полный цикл управления страницами
- [ ] **Добавить WYSIWYG редактор**: Интеграция с API для сохранения контента
- [ ] **Реализовать управление SEO**: Работа с SEO метаданными через API
- [ ] **Добавить управление меню**: Интеграция с Menu API (если реализован)
- [ ] **Тестирование**: Протестировать все операции со страницами

#### 2.6 Этап 6: Интеграция модуля реестра

**Цель**: Подключить управление реестром к реальному API

**Задачи**:
- [ ] **Обновить ArbitratorsService**: Адаптировать `arbitrators.ts` для работы с реальными эндпоинтами
- [ ] **Реализовать CRUD операции**: Полный цикл управления арбитражными управляющими
- [ ] **Добавить импорт/экспорт**: Интеграция с API импорта/экспорта
- [ ] **Реализовать поиск и фильтрацию**: Использование реальных параметров API
- [ ] **Добавить статистику**: Интеграция с API статистики реестра
- [ ] **Тестирование**: Протестировать все операции с реестром

#### 2.7 Этап 7: Интеграция модуля проверок

**Цель**: Подключить управление проверками к реальному API

**Задачи**:
- [ ] **Обновить InspectionsService**: Адаптировать `inspections.ts` для работы с реальными эндпоинтами
- [ ] **Реализовать CRUD операции**: Полный цикл управления проверками
- [ ] **Добавить календарный вид**: Интеграция с календарными эндпоинтами
- [ ] **Реализовать управление результатами**: Работа с результатами проверок через API
- [ ] **Добавить статистику**: Интеграция с API статистики проверок
- [ ] **Тестирование**: Протестировать все операции с проверками

#### 2.8 Этап 8: Интеграция модуля дисциплинарных мер

**Цель**: Подключить управление дисциплинарными мерами к реальному API

**Задачи**:
- [ ] **Обновить DisciplinaryMeasuresService**: Адаптировать `disciplinary-measures.ts` для работы с реальными эндпоинтами
- [ ] **Реализовать CRUD операции**: Полный цикл управления дисциплинарными мерами
- [ ] **Добавить управление апелляциями**: Работа с апелляциями через API
- [ ] **Реализовать поиск и фильтрацию**: Использование реальных параметров API
- [ ] **Добавить статистику**: Интеграция с API статистики дисциплинарных мер
- [ ] **Тестирование**: Протестировать все операции с дисциплинарными мерами

#### 2.9 Этап 9: Интеграция модуля настроек

**Цель**: Подключить управление настройками к реальному API

**Задачи**:
- [ ] **Обновить SettingsService**: Адаптировать `settings.ts` для работы с реальными эндпоинтами
- [ ] **Реализовать управление настройками сайта**: Работа с SiteSettings API
- [ ] **Добавить управление пользователями**: Интеграция с Users API
- [ ] **Реализовать настройки безопасности**: Работа с SecuritySettings API
- [ ] **Добавить управление темами**: Интеграция с ThemeSettings API
- [ ] **Тестирование**: Протестировать все операции с настройками

#### 2.10 Этап 10: Интеграция модуля файлов

**Цель**: Подключить управление файлами к реальному API

**Задачи**:
- [ ] **Обновить FilesService**: Адаптировать `files.ts` для работы с реальными эндпоинтами
- [ ] **Реализовать загрузку файлов**: Интеграция с Files API
- [ ] **Добавить управление изображениями**: Работа с обработкой изображений через API
- [ ] **Реализовать предварительный просмотр**: Интеграция с Files API для просмотра
- [ ] **Добавить управление метаданными**: Работа с метаданными файлов через API
- [ ] **Тестирование**: Протестировать все операции с файлами

### 3. ТЕХНИЧЕСКИЕ ЗАДАЧИ ИНТЕГРАЦИИ

#### 3.1 Настройка окружения

**Задачи**:
- [ ] **Создать .env файлы**: Настроить переменные окружения для admin-panel
- [ ] **Настроить CORS**: Обновить CORS настройки в backend для admin-panel
- [ ] **Настроить прокси**: Настроить прокси для разработки (если необходимо)
- [ ] **Документация**: Создать документацию по настройке окружения

#### 3.2 Обработка ошибок

**Задачи**:
- [ ] **Централизованная обработка**: Реализовать централизованную обработку ошибок API
- [ ] **Пользовательские уведомления**: Добавить пользовательские уведомления об ошибках
- [ ] **Логирование**: Настроить логирование ошибок для отладки
- [ ] **Retry логика**: Добавить retry логику для failed запросов

#### 3.3 Оптимизация производительности

**Задачи**:
- [ ] **Кэширование**: Реализовать кэширование API запросов
- [ ] **Lazy loading**: Добавить lazy loading для страниц админки
- [ ] **Оптимизация запросов**: Оптимизировать API запросы для уменьшения нагрузки
- [ ] **Индикаторы загрузки**: Добавить индикаторы загрузки для всех операций

#### 3.4 Тестирование

**Задачи**:
- [ ] **Unit тесты**: Написать unit тесты для всех сервисов
- [ ] **Integration тесты**: Создать integration тесты для API
- [ ] **E2E тесты**: Реализовать e2e тесты для основных сценариев
- [ ] **Нагрузочное тестирование**: Провести нагрузочное тестирование API

### 4. МИГРАЦИЯ С МОКОВЫХ ДАННЫХ

#### 4.1 Поэтапная миграция

**Задачи**:
- [ ] **Создать флаг миграции**: Добавить флаг для переключения между моковыми данными и API
- [ ] **Поэтапное переключение**: Переключать модули по одному с моковых данных на API
- [ ] **Fallback механизм**: Сохранить fallback на моковые данные при ошибках API
- [ ] **Тестирование**: Тестировать каждый модуль после переключения

#### 4.2 Обновление компонентов

**Задачи**:
- [ ] **Обновить хуки**: Адаптировать все хуки для работы с реальным API
- [ ] **Обновить формы**: Адаптировать формы для работы с реальными данными
- [ ] **Обновить таблицы**: Адаптировать таблицы для работы с реальными данными
- [ ] **Обновить фильтры**: Адаптировать фильтры для работы с реальными параметрами

### 5. ДОКУМЕНТАЦИЯ И ПОДДЕРЖКА

#### 5.1 Документация API

**Задачи**:
- [ ] **Swagger документация**: Настроить Swagger для backend API
- [ ] **Postman коллекции**: Обновить Postman коллекции с актуальными эндпоинтами
- [ ] **API документация**: Создать документацию по использованию API
- [ ] **Примеры интеграции**: Создать примеры интеграции для разработчиков

#### 5.2 Документация админки

**Задачи**:
- [ ] **Руководство пользователя**: Создать руководство по использованию админки
- [ ] **Техническая документация**: Создать техническую документацию для разработчиков
- [ ] **FAQ**: Создать FAQ по часто задаваемым вопросам
- [ ] **Видео инструкции**: Создать видео инструкции по использованию

### 6. КРИТЕРИИ ГОТОВНОСТИ

#### 6.1 Функциональность
- [ ] Все модули админки работают с реальным API
- [ ] Все CRUD операции выполняются корректно
- [ ] Поиск и фильтрация работают с реальными данными
- [ ] Загрузка файлов работает через API
- [ ] Аутентификация работает корректно

#### 6.2 Производительность
- [ ] Страницы загружаются менее чем за 2 секунды
- [ ] API запросы выполняются быстро
- [ ] Кэширование работает эффективно
- [ ] Нет утечек памяти

#### 6.3 Безопасность
- [ ] JWT токены работают корректно
- [ ] Авторизация работает по ролям
- [ ] Валидация данных работает на всех уровнях
- [ ] Логирование работает корректно

#### 6.4 Тестирование
- [ ] Unit тесты покрывают 80% кода
- [ ] Integration тесты покрывают все API
- [ ] E2E тесты покрывают основные сценарии
- [ ] Нагрузочное тестирование пройдено

---

## ЗАКЛЮЧЕНИЕ

Данное техническое задание содержит подробный план исправления всех выявленных недочетов в монорепозитории и полную интеграцию API с админ панелью. Выполнение задач в указанном порядке обеспечит:

1. **Устранение критичных проблем** с аутентификацией, типами данных и API контрактами
2. **Полную интеграцию** админ панели с backend API
3. **Унификацию** UI компонентов и стилей
4. **Повышение безопасности** и надежности системы
5. **Улучшение производительности** и пользовательского опыта

Все задачи детализированы и готовы к выполнению с возможностью отметки о завершении через `[ ]` чекбоксы.
